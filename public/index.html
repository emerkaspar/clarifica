<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-," />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CLARIFICA - O seu farol de investimentos</title>
    <link
      rel="icon"
      type="image/png"
      href="https://raw.githubusercontent.com/emerkaspar/clarifica/refs/heads/main/favicon.png"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
      body {
        background-color: #0f1011;
        color: #e0e0e0;
        font-family: "Open Sans", sans-serif;
        margin: 0;
        padding: 0;
      }
      .container {
        max-width: 1100px;
        margin: 0 auto;
        padding: 20px;
      }
      .top-menu-container {
        background-color: #1a1b1e;
        padding: 10px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 15px;
      }
      .top-menu-left {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .logo {
        display: flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
        color: inherit;
      }
      .logo img {
        height: 128px;
        width: auto;
      }
      .header-nav {
        display: none; /* Escondido por padrão */
        gap: 25px;
      }
      .header-nav a {
        color: #a0a7b3;
        text-decoration: none;
        font-weight: 500;
        font-size: 0.9rem;
        transition: color 0.2s ease-in-out;
      }
      .header-nav a:hover {
        color: #00d9c3;
      }

      .top-menu-right {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      #btn-header-login-google {
        background-color: #00d9c3;
        color: #1f2937;
        font-weight: 600;
        font-size: 0.9rem;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        display: none;
        align-items: center;
        gap: 8px;
        transition: background-color 0.2s ease-in-out;
      }
      #btn-header-login-google:hover {
        background-color: #00c2af;
      }
      #user-info {
        display: none;
        align-items: center;
        gap: 10px;
        background-color: #1a1b1e;
        padding: 8px 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        position: relative;
        cursor: pointer;
      }
      #user-info img {
        width: 32px;
        height: 32px;
        border-radius: 50%;
      }
      #user-info #user-name {
        font-weight: 600;
        color: #e0e0e0;
      }
      #user-dropdown {
        position: absolute;
        top: calc(100% + 10px);
        right: 0;
        background-color: #1a1b1e;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        min-width: 220px;
        z-index: 1000;
        display: none;
        overflow: hidden;
      }
      #user-dropdown.show {
        display: block;
      }
      .user-dropdown-header {
        background-color: #00d9c3;
        color: #1f2937;
        padding: 15px;
        text-align: left;
      }
      .user-dropdown-header p {
        margin: 0;
        font-weight: 600;
        font-size: 1.1rem;
      }
      .user-dropdown-header span {
        font-size: 0.85rem;
        color: rgba(31, 41, 55, 0.8);
      }
      .user-dropdown-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 15px;
        color: #e0e0e0;
        text-decoration: none;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
        border-top: 1px solid #2a2c30;
      }
      .user-dropdown-item:hover {
        background-color: #2a2c30;
      }
      .user-dropdown-item svg {
        width: 16px;
        height: 16px;
        fill: #e0e0e0;
      }
      .main-content-wrapper {
        background-color: #161a22;
        border-radius: 8px;
        padding-top: 15px;
      }

      /* --- NOVO ESTILO DO MENU --- */
      .nav-tabs-wrapper {
        padding: 0 25px;
        border-bottom: 1px solid #2a2c30;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .nav-tabs-wrapper::-webkit-scrollbar {
        height: 2px;
      }
      .nav-tabs-wrapper::-webkit-scrollbar-thumb {
        background: #3a404d;
      }
      .nav-tabs {
        display: flex;
        flex-wrap: nowrap;
        list-style: none;
        padding: 0;
        margin: 0;
        gap: 25px;
      }
      .nav-tabs .nav-link {
        display: block;
        padding: 12px 0;
        text-decoration: none;
        background-color: transparent;
        color: #a0a7b3;
        border: none;
        border-bottom: 2px solid transparent;
        border-radius: 0;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.2s ease-in-out;
        margin-bottom: -1px;
        white-space: nowrap;
      }
      .nav-tabs .nav-link:hover:not(.active) {
        color: #e0e0e0;
        border-bottom-color: #3a404d;
      }
      .nav-tabs .nav-link.active {
        color: #00d9c3;
        background-color: transparent;
        border-bottom: 2px solid #00d9c3;
        font-weight: 600;
      }

      .tab-content {
        padding: 30px;
      }
      .tab-pane {
        display: none;
      }
      .tab-pane.active {
        display: block;
      }
      .tab-pane > h2 {
        margin-top: 0;
        font-weight: 600;
        border-bottom: 1px solid #2a2c30;
        padding-bottom: 10px;
        color: #f8f9fa;
      }

      /* --- NOVA SEÇÃO DE BOAS-VINDAS --- */
      #welcome-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        min-height: calc(100vh - 200px);
        padding: 20px;
      }
      .welcome-content h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 15px;
        color: #f8f9fa;
      }
      .welcome-content .highlight {
        color: #00d9c3;
      }
      .welcome-content p {
        max-width: 600px;
        margin: 0 auto 40px auto;
        font-size: 1.1rem;
        line-height: 1.6;
        color: #a0a7b3;
      }
      .features {
        display: flex;
        justify-content: center;
        gap: 30px;
        flex-wrap: wrap;
      }
      .feature-item {
        background-color: #161a22;
        padding: 25px;
        border-radius: 8px;
        border: 1px solid #2a2c30;
        width: 250px;
        text-align: center;
      }
      .feature-item i {
        font-size: 2rem;
        color: #00d9c3;
        margin-bottom: 15px;
      }
      .feature-item h3 {
        margin: 0 0 10px 0;
        font-size: 1.2rem;
        color: #e0e0e0;
      }
      .feature-item p {
        font-size: 0.9rem;
        color: #a0a7b3;
        line-height: 1.5;
        margin: 0;
      }

      #app-content {
        display: none;
      }
      
      /* --- ESTILO PARA O CONTAINER DO GRÁFICO --- */
      #movimentacao-chart-container {
        margin-bottom: 30px;
        background-color: #1a1b1e;
        border-radius: 8px;
        padding: 20px;
        border: 1px solid #2a2c30;
      }

      /* --- MODAL (USADO PARA LANÇAMENTO E CLASSIFICAÇÃO) --- */
      .modal-overlay {
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }
      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }
      .modal-content {
        background-color: #1a1b1e;
        border-radius: 12px;
        border: 1px solid #2a2c30;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        transform: translateY(-20px);
        transition: transform 0.3s ease;
      }
      .modal-overlay.show .modal-content {
        transform: translateY(0);
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 25px;
        border-bottom: 1px solid #2a2c30;
      }
      .modal-header h2 {
        margin: 0;
        font-size: 1.25rem;
        color: #e0e0e0;
      }
      .modal-close-btn {
        background: none;
        border: none;
        color: #a0a7b3;
        font-size: 1.5rem;
        cursor: pointer;
        transition: color 0.2s ease-in-out;
      }
      .modal-close-btn:hover {
        color: #00d9c3;
      }
      .modal-body {
        padding: 25px;
      }
      .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-bottom: 20px;
      }
      .form-label {
        display: block;
        margin-bottom: 5px;
        color: #a0a7b3;
        font-size: 0.85rem;
        font-weight: 500;
      }
      .form-input,
      .form-select {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #3a404d;
        background-color: #2a2c30;
        color: #e0e0e0;
        font-size: 0.95rem;
        box-sizing: border-box;
      }
      .form-input:focus,
      .form-select:focus {
        outline: none;
        border-color: #00d9c3;
        box-shadow: 0 0 0 3px rgba(0, 217, 195, 0.2);
      }
      .input-icon-wrapper {
        position: relative;
      }
      .input-icon-wrapper .form-input {
        padding-left: 35px;
      }
      .input-icon-wrapper i {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #a0a7b3;
        pointer-events: none;
      }

      /* --- ESTILOS DO AUTOCOMPLETE --- */
      .input-wrapper {
        position: relative;
      }
      .sugestoes-lista {
        position: absolute;
        top: calc(100% - 5px); /* Ajustado para cobrir o input */
        left: 0;
        right: 0;
        background-color: #252a33;
        border: 1px solid #3a404d;
        border-radius: 6px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 2100;
        display: none;
      }
      .sugestao-item {
        padding: 8px 12px;
        cursor: pointer;
        color: #e0e0e0;
        font-size: 0.9rem;
      }
      .sugestao-item:hover {
        background-color: #2c313d;
      }

      .tipo-operacao-modal {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      .tipo-operacao-modal button {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 15px 10px;
        background-color: #2a2c30;
        border: 1px solid #3a404d;
        border-radius: 8px;
        color: #a0a7b3;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
      }
      .tipo-operacao-modal button i {
        font-size: 1.3rem;
        margin-bottom: 5px;
        color: #a0a7b3;
        transition: color 0.2s ease-in-out;
      }
      .tipo-operacao-modal button.active {
        background-color: #1f2937;
        border-color: #00d9c3;
        color: #e0e0e0;
        box-shadow: 0 0 0 2px rgba(0, 217, 195, 0.4);
      }
      .tipo-operacao-modal button.active i {
        color: #00d9c3;
      }
      .tipo-operacao-modal button:hover:not(.active) {
        border-color: #00d9c3;
        box-shadow: 0 0 0 2px rgba(0, 217, 195, 0.2);
      }
      .modal-valor-total {
        background-color: #0f1011;
        border: 1px solid #2a2c30;
        border-radius: 8px;
        padding: 12px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        margin-bottom: 20px;
      }
      .modal-valor-total .label {
        font-size: 0.9rem;
        font-weight: 500;
        color: #a0a7b3;
      }
      .modal-valor-total .value {
        font-size: 1.2rem;
        font-weight: 600;
        color: #e0e0e0;
      }
      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        padding: 15px 25px;
        border-top: 1px solid #2a2c30;
      }
      .btn-cancelar {
        background: none;
        border: none;
        color: #a0a7b3;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        padding: 8px 15px;
        border-radius: 6px;
        transition: color 0.2s ease-in-out, background-color 0.2s ease-in-out;
      }
      .btn-cancelar:hover {
        color: #e0e0e0;
        background-color: #2a2c30;
      }
      .btn-adicionar, .btn-salvar {
        background-color: #00d9c3;
        color: #1f2937;
        font-weight: 600;
        font-size: 0.95rem;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background-color 0.2s ease-in-out;
      }
      .btn-adicionar:hover, .btn-salvar:hover {
        background-color: #00c2af;
      }

      /* --- ESTILOS TAB LANÇAMENTOS E CLASSIFICAÇÃO --- */
      .content-container {
        max-width: 900px;
        margin: 0 auto;
        padding-top: 30px;
      }
      .content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
      }
      .content-header h3 {
        color: #e0e0e0;
        margin: 0;
      }
      #search-ativo {
        background-color: #2a2c30;
        border: 1px solid #3a404d;
        border-radius: 6px;
        color: #e0e0e0;
        padding: 8px 12px;
        font-size: 0.9rem;
      }
      #btn-mostrar-form, #btn-lancamento-provento {
        font-size: 0.9rem;
        padding: 8px 15px;
      }
      .lista-wrapper {
        overflow-x: auto;
      }
      .lista-header {
        display: grid;
        gap: 15px;
        padding: 0 20px;
        margin-bottom: 5px;
      }
      .header-col {
        color: #a0a7b3;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
      }
      .lista-item {
        display: grid;
        gap: 15px;
        align-items: center;
        background-color: #1a1b1e;
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 8px;
        border: 1px solid #2a2c30;
        font-size: 0.9rem;
      }
      .lista-item-valor {
        font-weight: 500;
      }
      .tipo-ativo-badge {
        background-color: #2c313d;
        color: #a0a7b3;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-block;
      }
      .operacao-compra {
        color: #22c55e;
      }
      .operacao-venda {
        color: #ef4444;
      }
      .provento-recebido {
        color: #00d9c3;
      }
      .lista-acoes {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }
      .btn-crud {
        background: none;
        border: none;
        cursor: pointer;
        padding: 5px;
      }
      .btn-crud svg {
        width: 18px;
        height: 18px;
        transition: fill 0.2s ease-in-out;
      }
      .btn-editar svg, .btn-classificar svg {
        fill: #a0a7b3;
      }
      .btn-editar:hover svg, .btn-classificar:hover svg {
        fill: #00d9c3;
      }
      .btn-excluir svg {
        fill: #a0a7b3;
      }
      .btn-excluir:hover svg {
        fill: #ef4444;
      }
      #historico-lista p, #classificacao-lista p, #proventos-lista p {
        text-align: center;
        color: #a0a7b3;
        padding: 20px;
      }
      .status-classificacao {
        font-size: 0.85rem;
        font-weight: 600;
      }
      .status-classificado { color: #22c55e; }
      .status-nao-classificado { color: #ef4444; }


      /* --- MEDIA QUERIES PARA RESPONSIVIDADE --- */
      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }
        .logo img {
          height: 90px;
        }
        .header-nav {
          display: none;
        }
        .form-grid {
          grid-template-columns: 1fr;
        }
        .tab-content {
          padding: 20px;
        }
        .nav-tabs-wrapper {
          padding: 0 15px;
        }
        .welcome-content h1 {
          font-size: 2rem;
        }
      }

      @media (max-width: 480px) {
        .logo img {
          height: 64px;
        }
        .top-menu-container {
          padding: 5px 10px;
        }
        #user-info #user-name {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="top-menu-container">
        <div class="top-menu-left">
          <a href="#" class="logo"
            ><img
              src="https://raw.githubusercontent.com/emerkaspar/clarifica/refs/heads/main/Clarifica_logo.png"
              alt="Logomarca Clarifica"
          /></a>
        </div>
        <nav class="header-nav">
          <a href="#">Funcionalidades</a>
          <a href="#">Para Quem é?</a>
          <a href="#">Contato</a>
        </nav>
        <div class="top-menu-right">
          <button id="btn-header-login-google">
            <i class="fab fa-google"></i> Fazer Login
          </button>
          <div id="user-info">
            <img id="user-photo" src="" alt="Foto do usuário" /><span
              id="user-name"
            ></span>
            <div id="user-dropdown">
              <div class="user-dropdown-header">
                <p id="dropdown-user-name"></p>
                <span id="dropdown-user-email"></span>
              </div>
              <a href="#" id="btn-logout" class="user-dropdown-item"
                ><svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  fill="currentColor"
                  viewBox="0 0 16 16"
                >
                  <path
                    fill-rule="evenodd"
                    d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"
                  />
                  <path
                    fill-rule="evenodd"
                    d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"
                  />
                </svg>
                Sair</a
              >
            </div>
          </div>
        </div>
      </div>

      <div id="welcome-section">
        <div class="welcome-content">
          <h1>
            Seu portfólio de investimentos,
            <span class="highlight">claro e consolidado.</span>
          </h1>
          <p>
            Acompanhe todos os seus ativos em um só lugar. Ações, FIIs, ETFs,
            Criptomoedas e Renda Fixa. Tome decisões melhores com análises e
            relatórios intuitivos.
          </p>
          <div class="features">
            <div class="feature-item">
              <i class="fas fa-chart-pie"></i>
              <h3>Consolide</h3>
              <p>
                Tenha uma visão unificada de todo o seu patrimônio em diferentes
                corretoras e classes de ativos.
              </p>
            </div>
            <div class="feature-item">
              <i class="fas fa-hand-holding-usd"></i>
              <h3>Acompanhe</h3>
              <p>
                Monitore a rentabilidade, o recebimento de proventos e a
                evolução de cada ativo da sua carteira.
              </p>
            </div>
            <div class="feature-item">
              <i class="fas fa-lightbulb"></i>
              <h3>Clarifique</h3>
              <p>
                Use nossas ferramentas e análises para entender seus
                investimentos e planejar os próximos passos.
              </p>
            </div>
          </div>
        </div>
      </div>

      <div id="app-content">
        <div class="main-content-wrapper">
          <div class="nav-tabs-wrapper">
            <ul class="nav-tabs" id="myTab">
              <li>
                <a class="nav-link active" data-tab="patrimonio">Patrimônio</a>
              </li>
              <li>
                <a class="nav-link" data-tab="rentabilidade">Rentabilidade</a>
              </li>
              <li><a class="nav-link" data-tab="proventos">Proventos</a></li>
              <li><a class="nav-link" data-tab="acoes">Ações</a></li>
              <li><a class="nav-link" data-tab="fiis">Fiis</a></li>
              <li><a class="nav-link" data-tab="etf-cripto">Etf/Cripto</a></li>
              <li><a class="nav-link" data-tab="renda-fixa">Renda Fixa</a></li>
              <li><a class="nav-link" data-tab="calculos">Cálculos</a></li>
              <li><a class="nav-link" data-tab="analises">Análises</a></li>
              <li>
                <a class="nav-link" data-tab="lancamentos">Lançamentos</a>
              </li>
              <li>
                <a class="nav-link" data-tab="classificacao">Classificação</a>
              </li>
            </ul>
          </div>
          <div class="tab-content" id="myTabContent">
            <div class="tab-pane active" id="patrimonio"> <h2>Visão Geral do Patrimônio</h2> <p> Em breve: consolidação total da sua carteira, gráficos de evolução e alocação por tipo de ativo. </p> </div>
            <div class="tab-pane" id="rentabilidade"> <h2>Análise de Rentabilidade</h2> <p> Em breve: acompanhe a rentabilidade da sua carteira, comparativos com benchmarks e desempenho de cada ativo. </p> </div>
            
            <div class="tab-pane" id="proventos"> 
                <div class="content-container">
                    <div class="content-header">
                        <h3>Acompanhamento de Proventos</h3>
                        <button id="btn-lancamento-provento" class="btn-adicionar">
                            <i class="fas fa-plus"></i> Lançar Provento
                        </button>
                    </div>
                    <div class="lista-wrapper">
                         <div class="lista-header" style="grid-template-columns: 2fr 1fr 1.5fr 1.5fr 1.5fr auto; min-width: 600px;">
                            <div class="header-col">Ativo</div>
                            <div class="header-col">Tipo</div>
                            <div class="header-col">Provento</div>
                            <div class="header-col">Data Pagamento</div>
                            <div class="header-col">Valor (R$)</div>
                            <div class="header-col" style="text-align: right;">Ações</div>
                        </div>
                        <div id="proventos-lista">
                            </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane" id="acoes"> <h2>Carteira de Ações</h2> <p> Em breve: detalhes sobre suas posições em ações, dividendos recebidos, preço médio e resultados. </p> </div>
            <div class="tab-pane" id="fiis"> <h2>Carteira de FIIs</h2> <p> Em breve: detalhes sobre seus Fundos Imobiliários, rendimentos mensais, valor patrimonial e indicadores. </p> </div>
            <div class="tab-pane" id="etf-cripto"> <h2>ETFs e Criptomoedas</h2> <p> Em breve: consolidação de seus investimentos em ETFs e criptoativos. </p> </div>
            <div class="tab-pane" id="renda-fixa"> <h2>Renda Fixa</h2> <p> Em breve: seus investimentos em Tesouro Direto, CDBs, LCIs, LCAs e outros. </p> </div>
            <div class="tab-pane" id="calculos"> <h2>Cálculos e Projeções</h2> <p> Em breve: ferramentas para cálculos de preço médio, projeção de aposentadoria e outras simulações. </p> </div>
            <div class="tab-pane" id="analises"> <h2>Análises Detalhadas</h2> <p> Em breve: análises detalhadas de seus investimentos. </p> </div>
            
            <div class="tab-pane" id="lancamentos">
              <div class="content-container">
                <div id="movimentacao-chart-container" style="margin-bottom: 30px;">
                    <h3 style="color: #e0e0e0; margin-top: 0; margin-bottom: 15px;">Movimentação (Últimos 6 Meses)</h3>
                    <canvas id="movimentacao-chart"></canvas>
                </div>

                <div class="content-header">
                  <h3>Histórico de Lançamentos</h3>
                  <div style="display: flex; align-items: center; gap: 15px">
                    <input
                      type="search"
                      id="search-ativo"
                      placeholder="Pesquisar ativo..."
                    />
                    <button id="btn-mostrar-form" class="btn-adicionar">
                      <i class="fas fa-plus"></i> Novo Lançamento
                    </button>
                  </div>
                </div>
                <div class="lista-wrapper">
                  <div class="lista-header" style="grid-template-columns: 2fr 1.5fr 1fr 1fr 1fr 1fr auto; min-width: 700px;">
                    <div class="header-col">Ativo</div>
                    <div class="header-col">Tipo</div>
                    <div class="header-col">Ordem</div>
                    <div class="header-col">Quantidade</div>
                    <div class="header-col">Preço Unitário</div>
                    <div class="header-col">Total</div>
                    <div class="header-col" style="text-align: right;">Ações</div>
                  </div>
                  <div id="historico-lista"></div>
                </div>
              </div>
            </div>

            <div class="tab-pane" id="classificacao">
              <div class="content-container">
                <div class="content-header">
                  <h3>Classificação de Ativos</h3>
                   <p style="color: #a0a7b3; margin: 0; font-size: 0.9rem;">Classifique um ativo uma única vez. A categoria será aplicada a todos os seus lançamentos.</p>
                </div>
                <div class="lista-wrapper">
                  <div class="lista-header" style="grid-template-columns: 2fr 1.5fr 1.5fr auto; min-width: 500px;">
                    <div class="header-col">Ativo</div>
                    <div class="header-col">Tipo</div>
                    <div class="header-col">Status</div>
                    <div class="header-col" style="text-align: right;">Ações</div>
                  </div>
                  <div id="classificacao-lista"></div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <div id="lancamento-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="lancamento-modal-title">Adicionar Lançamento</h2>
          <button class="modal-close-btn" data-modal="lancamento-modal">&times;</button>
        </div>
        <div class="modal-body">
          <form id="form-novo-ativo">
            <input type="hidden" id="doc-id" name="doc-id" />
            <div class="tipo-operacao-modal">
              <button type="button" class="btn-compra active" data-op="compra"> <i class="fas fa-arrow-down"></i> Compra </button>
              <button type="button" class="btn-venda" data-op="venda"> <i class="fas fa-arrow-up"></i> Venda </button>
            </div>
            <input type="hidden" id="operacao-tipo" name="operacao-tipo" value="compra"/>
            <div class="form-grid">
              <div>
                <label for="tipo-ativo" class="form-label">Tipo de ativo</label>
                <select id="tipo-ativo" name="tipo-ativo" class="form-select" required>
                  <option value="Ações">Ações</option>
                  <option value="FIIs">FIIs</option>
                  <option value="ETF">ETF</option>
                  <option value="Cripto">Criptomoedas</option>
                  <option value="Renda Fixa">Renda Fixa</option>
                  <option value="Tesouro Direto">Tesouro Direto</option>
                </select>
              </div>
              <div class="input-wrapper">
                <label for="ativo" class="form-label">Ativo</label>
                <input type="text" id="ativo" name="ativo" placeholder="Ex: PETR4" class="form-input" required autocomplete="off"/>
                <div id="ativo-sugestoes" class="sugestoes-lista"></div>
              </div>
              <div class="input-icon-wrapper">
                <label for="data-operacao" class="form-label">Data da Operação</label>
                <i class="fas fa-calendar-alt"></i>
                <input type="date" id="data-operacao" name="data-operacao" class="form-input" required/>
              </div>
              <div>
                <label for="quantidade" class="form-label">Quantidade</label>
                <input type="number" id="quantidade" name="quantidade" value="1" step="any" class="form-input" required/>
              </div>
              <div>
                <label for="preco" class="form-label">Preço em R$</label>
                <input type="number" id="preco" name="preco" placeholder="0,00" step="0.01" class="form-input" required/>
              </div>
              <div>
                <label for="outros-custos" class="form-label" style="display: flex; justify-content: space-between; width: 100%;">
                  <span>Outros custos</span><span style="color: #888">(Opcional)</span>
                </label>
                <input type="number" id="outros-custos" name="outros-custos" placeholder="0,00" step="0.01" class="form-input"/>
              </div>
            </div>
            <div class="modal-valor-total">
              <span class="label">Valor total</span>
              <span class="value" id="valor-total-calculado">R$ 0,00</span>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn-cancelar" data-modal="lancamento-modal"> Cancelar </button>
              <button type="submit" class="btn-adicionar"> <i class="fas fa-plus"></i> Adicionar </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div id="provento-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="provento-modal-title">Lançar Provento Recebido</h2>
                <button class="modal-close-btn" data-modal="provento-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-novo-provento">
                    <input type="hidden" id="provento-doc-id" name="doc-id" />
                    <div class="tipo-operacao-modal" style="margin-bottom: 25px;">
                        <button type="button" class="btn-tipo-provento active" data-tipo="Ações"> <i class="fas fa-chart-line"></i> Ações </button>
                        <button type="button" class="btn-tipo-provento" data-tipo="FIIs"> <i class="fas fa-building"></i> FIIs </button>
                    </div>
                    <input type="hidden" id="provento-tipo-ativo" name="provento-tipo-ativo" value="Ações"/>

                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="input-wrapper">
                            <label for="provento-ativo" class="form-label">Ticker do Ativo</label>
                            <input type="text" id="provento-ativo" name="provento-ativo" placeholder="Ex: PETR4 ou HGBS11" class="form-input" required autocomplete="off"/>
                            <div id="provento-ativo-sugestoes" class="sugestoes-lista"></div>
                        </div>
                        <div>
                            <label for="provento-tipo-provento" class="form-label">Tipo de Provento</label>
                            <select id="provento-tipo-provento" name="provento-tipo-provento" class="form-select" required>
                                <option value="Dividendos">Dividendos</option>
                                <option value="JCP">JCP (Juros s/ Capital Próprio)</option>
                                <option value="Premios por opção">Prêmios por opção</option>
                            </select>
                        </div>
                        <div class="input-icon-wrapper">
                            <label for="provento-data-pagamento" class="form-label">Data de Pagamento</label>
                            <i class="fas fa-calendar-alt"></i>
                            <input type="date" id="provento-data-pagamento" name="provento-data-pagamento" class="form-input" required/>
                        </div>
                        <div>
                            <label for="provento-valor" class="form-label">Valor Recebido em R$ (Total)</label>
                            <input type="number" id="provento-valor" name="provento-valor" placeholder="0,00" step="0.01" class="form-input" required/>
                        </div>
                    </div>
                    
                    <div class="modal-footer" style="padding-top: 25px; padding-right: 0; padding-bottom: 0;">
                        <button type="button" class="btn-cancelar" data-modal="provento-modal">Cancelar</button>
                        <button type="submit" class="btn-adicionar"><i class="fas fa-plus"></i> Lançar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <div id="classificacao-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="classificacao-modal-title">Classificar Ativo</h2>
                <button class="modal-close-btn" data-modal="classificacao-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-classificacao">
                    <input type="hidden" id="classificacao-ativo-ticker">
                    <input type="hidden" id="classificacao-ativo-tipo">
                    <p style="color: #a0a7b3; margin-top: 0;">Ativo: <strong id="classificacao-ativo-nome" style="color: #e0e0e0;"></strong></p>
                    <div id="classificacao-fields-container" class="form-grid" style="margin-bottom: 0;">
                        </div>
                    <div class="modal-footer" style="padding-top: 25px; padding-right: 0; padding-bottom: 0;">
                        <button type="button" class="btn-cancelar" data-modal="classificacao-modal">Cancelar</button>
                        <button type="submit" class="btn-salvar"><i class="fas fa-save"></i> Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
      import {
        getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, where, orderBy, getDoc, updateDoc, serverTimestamp, setDoc, getDocs
      } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
      import {
        getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
      } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

      document.addEventListener("DOMContentLoaded", function () {
        // --- INICIALIZAÇÃO E REFERÊNCIAS ---
        const firebaseConfig = {
          apiKey: "AIzaSyA08o5_6YY7I1eCZ3DCPCopAJAUiC2JNdA",
          authDomain: "clarifica-invest.firebaseapp.com",
          projectId: "clarifica-invest",
          storageBucket: "clarifica-invest.appspot.com",
          messagingSenderId: "865871192847",
          appId: "1:865871192847:web:369d4b0edc96f74b29147a",
          measurementId: "G-6PG9XZJPB9",
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentuserID = null;
        let movimentacaoChart = null; // Instância do Chart.js para o gráfico de movimentação

        // --- LÓGICA DE AUTENTICAÇÃO E UI GERAL ---
        const btnHeaderLoginGoogle = document.getElementById("btn-header-login-google");
        const userInfoDiv = document.getElementById("user-info");
        const appContent = document.getElementById("app-content");
        const welcomeSection = document.getElementById("welcome-section");

        onAuthStateChanged(auth, (user) => {
          if (user) {
            currentuserID = user.uid;
            updateUIForLoggedInUser(user);
            initializeAppData(user.uid);
          } else {
            currentuserID = null;
            updateUIForLoggedOutUser();
          }
        });

        const updateUIForLoggedInUser = (user) => {
          welcomeSection.style.display = "none";
          appContent.style.display = "block";
          userInfoDiv.style.display = "flex";
          btnHeaderLoginGoogle.style.display = "none";
          document.getElementById("user-photo").src = user.photoURL;
          document.getElementById("user-name").textContent = user.displayName;
          document.getElementById("dropdown-user-name").textContent = user.displayName;
          document.getElementById("dropdown-user-email").textContent = user.email;
        };
        
        const updateUIForLoggedOutUser = () => {
          welcomeSection.style.display = "flex";
          appContent.style.display = "none";
          userInfoDiv.style.display = "none";
          btnHeaderLoginGoogle.style.display = "flex";
        };

        btnHeaderLoginGoogle.addEventListener("click", () => signInWithPopup(auth, provider).catch(console.error));
        document.getElementById("btn-logout").addEventListener("click", (e) => { e.preventDefault(); signOut(auth).catch(console.error); });
        userInfoDiv.addEventListener("click", () => document.getElementById("user-dropdown").classList.toggle("show"));
        document.addEventListener("click", (e) => {
          if (userInfoDiv && !userInfoDiv.contains(e.target)) document.getElementById("user-dropdown").classList.remove("show");
        });

        // --- NAVEGAÇÃO POR ABAS ---
        const tabs = document.querySelectorAll(".nav-tabs .nav-link");
        const tabPanes = document.querySelectorAll(".tab-pane");
        tabs.forEach(tab => {
            tab.addEventListener("click", function(e) {
                e.preventDefault();
                tabs.forEach(t => t.classList.remove("active"));
                tabPanes.forEach(p => p.classList.remove("active"));
                this.classList.add("active");
                document.getElementById(this.getAttribute("data-tab")).classList.add("active");
            });
        });

        // --- LÓGICA PRINCIPAL DA APLICAÇÃO ---
        function initializeAppData(userID) {
            const lancamentosCollection = collection(db, "lancamentos");
            const ativosClassificadosCollection = collection(db, "ativosClassificados");
            const proventosCollection = collection(db, "proventos"); 

            // Queries
            const qLancamentos = query(lancamentosCollection, where("userID", "==", userID), orderBy("timestamp", "desc"));
            const qClassificacoes = query(ativosClassificadosCollection, where("userID", "==", userID));
            // Ordena proventos por data de pagamento (desc) para mostrar os mais recentes primeiro
            const qProventos = query(proventosCollection, where("userID", "==", userID), orderBy("dataPagamento", "desc"));

            let allLancamentos = [];
            let allClassificacoes = {};
            // let allProventos = []; // Não é mais necessário, o listener abaixo já renderiza

            // Listener para classificações
            onSnapshot(qClassificacoes, (snapshot) => {
                allClassificacoes = {};
                snapshot.docs.forEach(doc => {
                    allClassificacoes[doc.id] = doc.data();
                });
                renderClassificacao(allLancamentos, allClassificacoes); 
            });

            // Listener para lançamentos
            onSnapshot(qLancamentos, (snapshot) => {
                allLancamentos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderHistorico(allLancamentos);
                renderClassificacao(allLancamentos, allClassificacoes);
                renderMovimentacaoChart(allLancamentos); 
            });
            
            // Listener para proventos
            onSnapshot(qProventos, (snapshot) => {
                 const allProventos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 renderProventos(allProventos);
            });


            setupLancamentosModal(userID);
            setupClassificacaoModal(userID, ativosClassificadosCollection);
            setupProventoModal(userID); 
        }
        
        // --- LÓGICA DA ABA DE PROVENTOS (LISTAGEM) ---
        const proventosListaDiv = document.getElementById("proventos-lista");
        
        const renderProventos = (proventos) => {
            if (proventos.length === 0) {
                proventosListaDiv.innerHTML = `<p>Nenhum provento lançado ainda.</p>`;
                return;
            }

            proventosListaDiv.innerHTML = proventos.map(p => `
                <div class="lista-item" style="grid-template-columns: 2fr 1fr 1.5fr 1.5fr 1.5fr auto; min-width: 600px;">
                    <div class="lista-item-valor">${p.ativo}</div>
                    <div><span class="tipo-ativo-badge">${p.tipoAtivo}</span></div>
                    <div class="lista-item-valor provento-recebido">${p.tipoProvento}</div>
                    <div class="lista-item-valor">${p.dataPagamento}</div>
                    <div class="lista-item-valor">${p.valor.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}</div>
                    <div class="lista-acoes">
                        <button class="btn-crud btn-excluir-provento" data-id="${p.id}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
                    </div>
                </div>
            `).join("");
        }

        proventosListaDiv.addEventListener("click", async (e) => {
            const button = e.target.closest("button.btn-excluir-provento");
            if (!button || !currentuserID) return;
            const docId = button.dataset.id;
            
            if (confirm("Tem certeza que deseja excluir este provento?")) {
                await deleteDoc(doc(db, "proventos", docId)).catch(err => alert("Erro ao excluir: " + err.message));
            }
        });


        // --- LÓGICA DO GRÁFICO DE MOVIMENTAÇÃO (ÚLTIMOS 6 MESES) ---
        const renderMovimentacaoChart = (lancamentos) => {
            const chartCanvas = document.getElementById('movimentacao-chart');
            if (!chartCanvas || typeof Chart === 'undefined') return;

            // 1. Calcular o intervalo de 6 meses
            const now = new Date();
            const last6MonthsData = {};
            const labels = [];
            const dataAtual = new Date();
            dataAtual.setDate(1); // Começa no 1º dia do mês

            // Preencher com os 6 meses anteriores (incluindo o mês atual)
            for (let i = 5; i >= 0; i--) {
                const date = new Date(dataAtual.getFullYear(), dataAtual.getMonth() - i, 1);
                // Formato 'YYYY-MM' para a chave do objeto (facilita a ordenação)
                const monthYearKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                // Formato de exibição para o label
                labels.push(date.toLocaleString('pt-BR', { month: 'short', year: '2-digit' }));
                last6MonthsData[monthYearKey] = { compra: 0, venda: 0 };
            }

            // 2. Agregar dados
            const minDateKey = Object.keys(last6MonthsData)[0]; // O mês mais antigo na chave YYYY-MM
            lancamentos.forEach(l => {
                // O campo 'data' vem no formato 'YYYY-MM-DD'
                const [year, month, day] = l.data.split('-').map(Number);
                const dataOp = new Date(year, month - 1, day);
                const monthYearKey = `${dataOp.getFullYear()}-${String(dataOp.getMonth() + 1).padStart(2, '0')}`;
                
                // Só agrega se estiver dentro dos 6 meses
                if (monthYearKey >= minDateKey) { 
                    const valor = l.valorTotal || 0;
                    if (l.tipoOperacao === 'compra' && last6MonthsData[monthYearKey]) {
                        last6MonthsData[monthYearKey].compra += valor;
                    } else if (l.tipoOperacao === 'venda' && last6MonthsData[monthYearKey]) {
                        last6MonthsData[monthYearKey].venda += valor;
                    }
                }
            });

            // 3. Formatar dados para Chart.js
            const compras = Object.values(last6MonthsData).map(data => data.compra);
            const vendas = Object.values(last6MonthsData).map(data => data.venda);
            
            const data = {
                labels: labels, // Labels já estão ordenados de forma crescente
                datasets: [
                    {
                        label: 'Compras (R$)',
                        data: compras,
                        backgroundColor: 'rgba(34, 197, 94, 0.7)',
                        borderColor: 'rgb(34, 197, 94)',
                        borderWidth: 1,
                        borderRadius: 4
                    },
                    {
                        label: 'Vendas (R$)',
                        data: vendas,
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        borderColor: 'rgb(239, 68, 68)',
                        borderWidth: 1,
                        borderRadius: 4
                    }
                ]
            };

            // 4. Renderizar o gráfico
            if (movimentacaoChart) {
                movimentacaoChart.destroy();
            }

            movimentacaoChart = new Chart(chartCanvas, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: {
                            stacked: false,
                            grid: { color: '#2a2c30' },
                            ticks: { color: '#e0e0e0' }
                        },
                        y: {
                            stacked: false,
                            beginAtZero: true,
                            grid: { color: '#2a2c30' },
                            ticks: { 
                                color: '#e0e0e0',
                                callback: function(value) {
                                    return 'R$ ' + value.toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#e0e0e0' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        };


        // --- LÓGICA DA ABA DE LANÇAMENTOS ---
        const historicoListaDiv = document.getElementById("historico-lista");
        const searchInput = document.getElementById("search-ativo");

        const renderHistorico = (lancamentos) => {
            const searchTerm = searchInput.value.toUpperCase();
            const lancamentosFiltrados = lancamentos.filter(l => l.ativo.toUpperCase().includes(searchTerm));

            if (lancamentosFiltrados.length === 0) {
                historicoListaDiv.innerHTML = `<p>Nenhum lançamento encontrado.</p>`;
                return;
            }
            historicoListaDiv.innerHTML = lancamentosFiltrados.map(l => `
                <div class="lista-item" style="grid-template-columns: 2fr 1.5fr 1fr 1fr 1fr 1fr auto; min-width: 700px;">
                    <div class="lista-item-valor">${l.ativo}</div>
                    <div><span class="tipo-ativo-badge">${l.tipoAtivo}</span></div>
                    <div class="lista-item-valor ${l.tipoOperacao === 'compra' ? 'operacao-compra' : 'operacao-venda'}">${l.tipoOperacao.charAt(0).toUpperCase() + l.tipoOperacao.slice(1)}</div>
                    <div class="lista-item-valor">${l.quantidade.toLocaleString("pt-BR")}</div>
                    <div class="lista-item-valor">${l.preco.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}</div>
                    <div class="lista-item-valor">${l.valorTotal.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}</div>
                    <div class="lista-acoes">
                        <button class="btn-crud btn-editar" data-id="${l.id}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                        <button class="btn-crud btn-excluir" data-id="${l.id}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
                    </div>
                </div>
            `).join("");
        };

        historicoListaDiv.addEventListener("click", async (e) => {
            const button = e.target.closest("button.btn-crud");
            if (!button || !currentuserID) return;
            const docId = button.dataset.id;
            
            if (button.classList.contains("btn-excluir")) {
                if (confirm("Tem certeza que deseja excluir este lançamento?")) {
                    await deleteDoc(doc(db, "lancamentos", docId)).catch(err => alert("Erro ao excluir: " + err.message));
                }
            } else if (button.classList.contains("btn-editar")) {
                const docSnap = await getDoc(doc(db, "lancamentos", docId));
                if (docSnap.exists()) {
                    openLancamentoModal(docSnap.data(), docId);
                }
            }
        });
        
        searchInput.addEventListener("input", () => {
            // A re-renderização é forçada aqui para atualizar a lista imediatamente
            const q = query(collection(db, "lancamentos"), where("userID", "==", currentuserID), orderBy("timestamp", "desc"));
            getDocs(q).then(snapshot => {
                const allLancamentos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderHistorico(allLancamentos);
            })
        });

        // --- LÓGICA DA ABA DE CLASSIFICAÇÃO ---
        const classificacaoListaDiv = document.getElementById("classificacao-lista");

        const renderClassificacao = (lancamentos, classificacoes) => {
            const ativosUnicos = {};
            lancamentos.forEach(l => {
                if (!ativosUnicos[l.ativo]) {
                    ativosUnicos[l.ativo] = l.tipoAtivo;
                }
            });

            if (Object.keys(ativosUnicos).length === 0) {
                classificacaoListaDiv.innerHTML = `<p>Adicione um lançamento para começar a classificar seus ativos.</p>`;
                return;
            }

            classificacaoListaDiv.innerHTML = Object.entries(ativosUnicos).map(([ticker, tipo]) => {
                const isClassificado = classificacoes[ticker];
                return `
                    <div class="lista-item" style="grid-template-columns: 2fr 1.5fr 1.5fr auto; min-width: 500px;">
                        <div class="lista-item-valor">${ticker}</div>
                        <div><span class="tipo-ativo-badge">${tipo}</span></div>
                        <div>
                            <span class="status-classificacao ${isClassificado ? 'status-classificado' : 'status-nao-classificado'}">
                                ${isClassificado ? 'Classificado' : 'Não Classificado'}
                            </span>
                        </div>
                        <div class="lista-acoes">
                           <button class="btn-crud btn-classificar" data-ticker="${ticker}" data-tipo="${tipo}">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                ${isClassificado ? 'Editar' : 'Classificar'}
                           </button>
                        </div>
                    </div>
                `
            }).join("");
        };

        classificacaoListaDiv.addEventListener("click", async (e) => {
            const button = e.target.closest("button.btn-classificar");
            if (!button || !currentuserID) return;

            const ticker = button.dataset.ticker;
            const tipo = button.dataset.tipo;

            const docRef = doc(db, "ativosClassificados", ticker);
            const docSnap = await getDoc(docRef);
            const existingData = docSnap.exists() ? docSnap.data().classificacoes : {};

            openClassificacaoModal(ticker, tipo, existingData);
        });


        // --- SETUP DOS MODAIS ---

        // Função de utilidade para fechar modais
        const closeModal = (modalId) => {
            document.getElementById(modalId).classList.remove("show");
        }
        document.querySelectorAll(".modal-close-btn, .btn-cancelar").forEach(btn => {
            btn.addEventListener("click", (e) => {
                const modalId = e.currentTarget.dataset.modal || e.currentTarget.closest(".modal-overlay").id;
                closeModal(modalId);
            });
        });

        // MODAL DE LANÇAMENTO DE ATIVOS
        function setupLancamentosModal(userID) {
            const modal = document.getElementById("lancamento-modal");
            const form = document.getElementById("form-novo-ativo");
            const hoje = new Date().toISOString().split("T")[0];
            
            // Auto complete
            const ativoInput = form.querySelector("#ativo");
            const sugestoesDiv = form.querySelector("#ativo-sugestoes");
            let timeoutBusca;

            ativoInput.addEventListener("input", () => {
                clearTimeout(timeoutBusca);
                const termo = ativoInput.value.trim().toUpperCase();
                if (termo.length < 2) { sugestoesDiv.style.display = "none"; return; }
                timeoutBusca = setTimeout(async () => {
                    try {
                        // Usando API da Brapi para sugestão de tickers
                        const resp = await fetch(`https://brapi.dev/api/available?search=${termo}`);
                        const data = await resp.json();
                        sugestoesDiv.innerHTML = "";
                        if (data && data.stocks && data.stocks.length > 0) {
                            sugestoesDiv.style.display = "block";
                            data.stocks.slice(0, 10).forEach(stock => {
                                const div = document.createElement("div");
                                div.className = "sugestao-item";
                                div.textContent = stock;
                                div.onclick = () => {
                                    ativoInput.value = stock;
                                    sugestoesDiv.style.display = "none";
                                };
                                sugestoesDiv.appendChild(div);
                            });
                        } else { sugestoesDiv.style.display = "none"; }
                    } catch (e) { console.error("Erro ao buscar ativos:", e); sugestoesDiv.style.display = "none";}
                }, 400);
            });
            document.addEventListener("click", (e) => { 
                if (ativoInput && !ativoInput.contains(e.target) && !sugestoesDiv.contains(e.target)) {
                    sugestoesDiv.style.display = "none";
                }
            });


            // Lógica do formulário
            const calcularTotal = () => {
                const qtd = parseFloat(form.quantidade.value) || 0;
                const prc = parseFloat(form.preco.value) || 0;
                const cst = parseFloat(form["outros-custos"].value) || 0;
                form.querySelector("#valor-total-calculado").textContent = (qtd * prc + cst).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
            };
            
            form.querySelectorAll("input[type='number']").forEach(el => el.addEventListener("input", calcularTotal));
            form.querySelector(".btn-compra").addEventListener("click", () => { form.querySelector("#operacao-tipo").value = "compra"; form.querySelector(".btn-compra").classList.add('active'); form.querySelector(".btn-venda").classList.remove('active'); });
            form.querySelector(".btn-venda").addEventListener("click", () => { form.querySelector("#operacao-tipo").value = "venda"; form.querySelector(".btn-venda").classList.add('active'); form.querySelector(".btn-compra").classList.remove('active'); });

            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const docId = form["doc-id"].value;
                const lancamentoData = {
                    userID: userID,
                    tipoOperacao: form["operacao-tipo"].value,
                    tipoAtivo: form["tipo-ativo"].value,
                    ativo: form.ativo.value.toUpperCase(),
                    data: form["data-operacao"].value,
                    quantidade: parseFloat(form.quantidade.value),
                    preco: parseFloat(form.preco.value),
                    custos: parseFloat(form["outros-custos"].value) || 0,
                    valorTotal: (parseFloat(form.quantidade.value) * parseFloat(form.preco.value)) + (parseFloat(form["outros-custos"].value) || 0),
                };

                try {
                    if (docId) {
                        await updateDoc(doc(db, "lancamentos", docId), lancamentoData);
                        alert("Lançamento atualizado!");
                    } else {
                        lancamentoData.timestamp = serverTimestamp();
                        await addDoc(collection(db, "lancamentos"), lancamentoData);
                        alert("Lançamento adicionado!");
                    }
                    closeModal("lancamento-modal");
                } catch (error) {
                    alert("Erro ao salvar: " + error.message);
                }
            });

            // Abrir/Fechar
            document.getElementById("btn-mostrar-form").addEventListener("click", () => openLancamentoModal());
            modal.addEventListener("click", e => { if (e.target === modal) closeModal("lancamento-modal"); });

            window.openLancamentoModal = (data = {}, id = "") => {
                form.reset();
                form["doc-id"].value = id;
                document.getElementById('lancamento-modal-title').textContent = id ? "Editar Lançamento" : "Adicionar Lançamento";
                form.querySelector('.btn-adicionar').innerHTML = id ? '<i class="fas fa-edit"></i> Atualizar' : '<i class="fas fa-plus"></i> Adicionar';

                form["tipo-ativo"].value = data.tipoAtivo || "Ações";
                form.ativo.value = data.ativo || "";
                form["data-operacao"].value = data.data || hoje;
                form.quantidade.value = data.quantidade || 1;
                form.preco.value = data.preco || "";
                form["outros-custos"].value = data.custos || "";
                form["operacao-tipo"].value = data.tipoOperacao || "compra";
                if(data.tipoOperacao === 'venda') { form.querySelector('.btn-venda').click(); } else { form.querySelector('.btn-compra').click(); }
                
                calcularTotal();
                modal.classList.add("show");
            };
        }


        // NOVO SETUP: MODAL DE LANÇAMENTO DE PROVENTOS
        function setupProventoModal(userID) {
            const modal = document.getElementById("provento-modal");
            const form = document.getElementById("form-novo-provento");
            const hoje = new Date().toISOString().split("T")[0];
            
            // Auto complete
            const ativoInput = form.querySelector("#provento-ativo");
            const sugestoesDiv = form.querySelector("#provento-ativo-sugestoes");
            let timeoutBusca;

            ativoInput.addEventListener("input", () => {
                clearTimeout(timeoutBusca);
                const termo = ativoInput.value.trim().toUpperCase();
                if (termo.length < 2) { sugestoesDiv.style.display = "none"; return; }
                timeoutBusca = setTimeout(async () => {
                    try {
                        const resp = await fetch(`https://brapi.dev/api/available?search=${termo}`);
                        const data = await resp.json();
                        sugestoesDiv.innerHTML = "";
                        if (data && data.stocks && data.stocks.length > 0) {
                            sugestoesDiv.style.display = "block";
                            data.stocks.slice(0, 10).forEach(stock => {
                                const div = document.createElement("div");
                                div.className = "sugestao-item";
                                div.textContent = stock;
                                div.onclick = () => {
                                    ativoInput.value = stock;
                                    sugestoesDiv.style.display = "none";
                                };
                                sugestoesDiv.appendChild(div);
                            });
                        } else { sugestoesDiv.style.display = "none"; }
                    } catch (e) { console.error("Erro ao buscar ativos:", e); sugestoesDiv.style.display = "none";}
                }, 400);
            });
            document.addEventListener("click", (e) => { 
                if (ativoInput && !ativoInput.contains(e.target) && !sugestoesDiv.contains(e.target)) {
                    sugestoesDiv.style.display = "none";
                }
            });

            // Lógica de seleção Ações/FIIs
            form.querySelectorAll(".btn-tipo-provento").forEach(btn => {
                btn.addEventListener("click", () => {
                    form.querySelectorAll(".btn-tipo-provento").forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                    form.querySelector("#provento-tipo-ativo").value = btn.dataset.tipo;
                });
            });

            // Lógica de submissão do formulário
            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const proventoData = {
                    userID: userID,
                    tipoAtivo: form["provento-tipo-ativo"].value,
                    ativo: form["provento-ativo"].value.toUpperCase(),
                    tipoProvento: form["provento-tipo-provento"].value, // NOVO CAMPO
                    dataPagamento: form["provento-data-pagamento"].value,
                    valor: parseFloat(form["provento-valor"].value),
                    timestamp: serverTimestamp(),
                };

                try {
                    await addDoc(collection(db, "proventos"), proventoData);
                    alert("Provento lançado com sucesso!");
                    form.reset();
                    closeModal("provento-modal");
                } catch (error) {
                    alert("Erro ao lançar provento: " + error.message);
                }
            });

            // Abrir/Fechar
            document.getElementById("btn-lancamento-provento").addEventListener("click", () => {
                 form["provento-data-pagamento"].value = hoje; // Define a data inicial
                 form["provento-tipo-provento"].value = "Dividendos"; // Define o default
                 modal.classList.add("show");
            });
            modal.addEventListener("click", e => { if (e.target === modal) closeModal("provento-modal"); });
        }


        // MODAL DE CLASSIFICAÇÃO
        function setupClassificacaoModal(userID, collectionRef) {
            const modal = document.getElementById("classificacao-modal");
            const form = document.getElementById("form-classificacao");
            const fieldsContainer = document.getElementById("classificacao-fields-container");

            const gerarCampos = (tipo, valores) => {
                let html = "";
                 if (tipo === "FIIs") {
                    html = `
                        <div>
                            <label class="form-label">Tipo FII</label>
                            <select name="Tipo FII" class="form-select">
                                <option value="Tijolo" ${valores["Tipo FII"] === 'Tijolo' ? 'selected' : ''}>Tijolo</option>
                                <option value="Papel" ${valores["Tipo FII"] === 'Papel' ? 'selected' : ''}>Papel</option>
                                <option value="Híbrido" ${valores["Tipo FII"] === 'Híbrido' ? 'selected' : ''}>Híbrido</option>
                                <option value="Fundo de Fundos" ${valores["Tipo FII"] === 'Fundo de Fundos' ? 'selected' : ''}>Fundo de Fundos</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Risco FII</label>
                            <select name="Risco FII" class="form-select">
                                <option value="Arrojado" ${valores["Risco FII"] === 'Arrojado' ? 'selected' : ''}>Arrojado</option>
                                <option value="Crescimento" ${valores["Risco FII"] === 'Crescimento' ? 'selected' : ''}>Crescimento</option>
                                <option value="Ancoragem" ${valores["Risco FII"] === 'Ancoragem' ? 'selected' : ''}>Ancoragem</option>
                            </select>
                        </div>`;
                } else if (tipo === "Ações") {
                     html = `
                        <div>
                            <label class="form-label">Capitalização</label>
                            <select name="Capitalização" class="form-select">
                                <option value="Blue Chip" ${valores["Capitalização"] === 'Blue Chip' ? 'selected' : ''}>Blue Chip</option>
                                <option value="Small Cap" ${valores["Capitalização"] === 'Small Cap' ? 'selected' : ''}>Small Cap</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Setor BESST</label>
                            <select name="Setor BESST" class="form-select">
                                <option value="Bancos" ${valores["Setor BESST"] === 'Bancos' ? 'selected' : ''}>Bancos</option>
                                <option value="Energia" ${valores["Setor BESST"] === 'Energia' ? 'selected' : ''}>Energia</option>
                                <option value="Saneamento" ${valores["Setor BESST"] === 'Saneamento' ? 'selected' : ''}>Saneamento</option>
                                <option value="Seguros" ${valores["Setor BESST"] === 'Seguros' ? 'selected' : ''}>Seguros</option>
                                <option value="Telecomunicações" ${valores["Setor BESST"] === 'Telecomunicações' ? 'selected' : ''}>Telecomunicações</option>
                                <option value="Outro" ${valores["Setor BESST"] === 'Outro' ? 'selected' : ''}>Outro</option>
                            </select>
                        </div>`;
                }
                fieldsContainer.innerHTML = html;
            };

            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const ticker = form['classificacao-ativo-ticker'].value;
                const tipo = form['classificacao-ativo-tipo'].value;

                const classificacoes = {};
                form.querySelectorAll("select").forEach(select => {
                    classificacoes[select.name] = select.value;
                });
                
                try {
                    const docRef = doc(db, "ativosClassificados", ticker);
                    await setDoc(docRef, {
                        userID: userID,
                        ativo: ticker,
                        tipoAtivo: tipo,
                        classificacoes: classificacoes
                    });
                    alert("Classificação salva com sucesso!");
                    closeModal("classificacao-modal");
                } catch (error) {
                    alert("Erro ao salvar classificação: " + error.message);
                }
            });

            // Abrir/Fechar
            modal.addEventListener("click", e => { if (e.target === modal) closeModal("classificacao-modal"); });

            window.openClassificacaoModal = (ticker, tipo, valores = {}) => {
                form.reset();
                form['classificacao-ativo-ticker'].value = ticker;
                form['classificacao-ativo-tipo'].value = tipo;
                document.getElementById('classificacao-ativo-nome').textContent = ticker;
                gerarCampos(tipo, valores);
                modal.classList.add("show");
            };
        }
      });
    </script>
  </body>
</html>