<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLARIFICA - O seu farol de investimentos</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/emerkaspar/clarifica/refs/heads/main/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* Estilos CSS continuam os mesmos */
        body { background-color: #0f1011; color: #e0e0e0; font-family: 'Open Sans', sans-serif; margin: 0; padding: 0; }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        .top-menu-container { background-color: #1a1b1e; padding: 10px 20px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; gap: 15px; }
        .top-menu-left { display: flex; align-items: center; gap: 10px; }
        .logo { display: flex; align-items: center; gap: 10px; text-decoration: none; color: inherit; }
        .logo img { height: 128px; width: auto; }
        .logo-text { font-size: 1.4rem; font-weight: 600; color: #e0e0e0; }
        .top-menu-right { display: flex; align-items: center; gap: 10px; }
        .top-menu-button { background-color: #2a2c30; color: #e0e0e0; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: background-color 0.2s ease-in-out; display: flex; align-items: center; gap: 5px; }
        .top-menu-button:hover { background-color: #3a3d42; }
        .top-menu-button.icon-only { padding: 8px; border-radius: 50%; }
        .top-menu-button svg { width: 16px; height: 16px; fill: #e0e0e0; }
        #user-info { display: flex; align-items: center; gap: 10px; }
        #user-info img { width: 32px; height: 32px; border-radius: 50%; }
        .main-content-wrapper { background-color: #161a22; border-radius: 8px; padding-top: 15px; }
        .nav-tabs-wrapper { padding: 0 15px; border-bottom: 1px solid #2a2c30; }
        .nav-tabs { display: flex; flex-wrap: wrap; list-style: none; padding: 0; margin: 0; gap: 10px; }
        .nav-tabs .nav-link { display: block; padding: 10px 18px; text-decoration: none; background-color: #2c313d; color: #a0a7b3; border: 1px solid #3a404d; border-radius: 6px 6px 0 0; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: all 0.2s ease-in-out; margin-bottom: -1px; }
        .nav-tabs .nav-link:hover:not(.active) { background-color: #383d47; color: #00d9c3; border-color: #4b5261; }
        .nav-tabs .nav-link.active { color: #1f2937; background-color: #d1d5db; border-color: #9ca3af; border-bottom: 1px solid #d1d5db; }
        .tab-content { padding: 30px; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        .tab-pane h2 { margin-top: 0; font-weight: 600; border-bottom: 1px solid #2a2c30; padding-bottom: 10px; color: #f8f9fa; }
        .lancamentos-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .lancamentos-table th, .lancamentos-table td { border: 1px solid #2a2c30; padding: 8px 12px; text-align: left; }
        .lancamentos-table th { background-color: #2c313d; color: #a0a7b3; }
        .lancamentos-section h3 { color: #00d9c3; margin-top: 25px; border-bottom: 1px solid #3a3d42; padding-bottom: 5px; }
        #form-lancamento { background-color: #1a1b1e; padding: 20px; border-radius: 8px; margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        #form-lancamento input, #form-lancamento select, #form-lancamento button { padding: 10px; border-radius: 5px; border: 1px solid #3a404d; background-color: #2a2c30; color: #e0e0e0; font-size: 0.9rem; }
        #form-lancamento button { background-color: #00d9c3; color: #1f2937; font-weight: 600; cursor: pointer; grid-column: 1 / -1; }
        .btn-delete { background-color: #5c2c2c; color: #e0e0e0; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        #app-content, #user-info { display: none; } /* Esconde o conteúdo principal e info do usuário por padrão */
        #login-message { text-align: center; padding: 50px; font-size: 1.2rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-menu-container">
            <div class="top-menu-left">
                <a href="#" class="logo">
                    <img src="https://raw.githubusercontent.com/emerkaspar/clarifica/refs/heads/main/Clarifica_logo.png" alt="Logomarca Clarifica">
                    <span class="logo-text">CLARIFICA</span>
                </a>
            </div>
            <div class="top-menu-right">
                <button class="top-menu-button" id="btn-login">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-google" viewBox="0 0 16 16"><path d="M15.545 6.558a9.42 9.42 0 0 1 .139 1.626c0 2.434-.87 4.492-2.384 5.885h.002C11.978 15.292 10.158 16 8 16A8 8 0 1 1 8 0a7.689 7.689 0 0 1 5.352 2.082l-2.284 2.284A4.347 4.347 0 0 0 8 3.166c-2.087 0-3.86 1.408-4.492 3.25C2.806 7.66 2.5 8.5 2.5 9.5s.306 1.84.814 2.583C3.934 13.593 5.713 15 8 15c1.464 0 2.766-.56 3.762-1.454L14.455 14.6A7.933 7.933 0 0 1 8 16z"/></svg>
                    Login com Google
                </button>
                <div id="user-info">
                    <img id="user-photo" src="" alt="Foto do usuário">
                    <span id="user-name"></span>
                    <button class="top-menu-button" id="btn-logout">Sair</button>
                </div>
            </div>
        </div>

        <div id="login-message">
            <h2>Bem-vindo ao Clarifica</h2>
            <p>Faça login com sua conta Google para gerenciar seus investimentos.</p>
        </div>

        <div id="app-content">
            <div class="main-content-wrapper">
                <div class="nav-tabs-wrapper"><ul class="nav-tabs" id="myTab"><li><a class="nav-link active" data-tab="patrimonio">Patrimônio</a></li><li><a class="nav-link" data-tab="rentabilidade">Rentabilidade</a></li><li><a class="nav-link" data-tab="acoes">Ações</a></li><li><a class="nav-link" data-tab="fiis">Fiis</a></li><li><a class="nav-link" data-tab="etf-cripto">Etf/Cripto</a></li><li><a class="nav-link" data-tab="renda-fixa">Renda Fixa</a></li><li><a class="nav-link" data-tab="calculos">Cálculos</a></li><li><a class="nav-link" data-tab="analises">Análises</a></li><li><a class="nav-link" data-tab="lancamentos">Lançamentos</a></li></ul></div>
                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane active" id="patrimonio"><h2>Visão Geral do Patrimônio</h2><p>Aqui você verá a consolidação total da sua carteira, gráficos de evolução e alocação por tipo de ativo.</p></div>
                    <div class="tab-pane" id="rentabilidade"><h2>Análise de Rentabilidade</h2><p>Acompanhe a rentabilidade da sua carteira, comparativos com benchmarks e desempenho de cada ativo.</p></div>
                    <div class="tab-pane" id="acoes"><h2>Carteira de Ações</h2><p>Detalhes sobre suas posições em ações, dividendos recebidos, preço médio e resultados.</p></div>
                    <div class="tab-pane" id="fiis"><h2>Carteira de FIIs</h2><p>Detalhes sobre seus Fundos Imobiliários, rendimentos mensais, valor patrimonial e indicadores.</p></div>
                    <div class="tab-pane" id="etf-cripto"><h2>ETFs e Criptomoedas</h2><p>Consolidação de seus investimentos em ETFs e criptoativos.</p></div>
                    <div class="tab-pane" id="renda-fixa"><h2>Renda Fixa</h2><p>Seus investimentos em Tesouro Direto, CDBs, LCIs, LCAs e outros ativos de renda fixa.</p></div>
                    <div class="tab-pane" id="calculos"><h2>Cálculos e Projeções</h2><p>Ferramentas para cálculos de preço médio, projeção de aposentadoria e outras simulações.</p></div>
                    <div class="tab-pane" id="analises"><h2>Análises Detalhadas</h2><p>Aqui você encontrará análises detalhadas de seus investimentos.</p></div>
                    <div class="tab-pane" id="lancamentos">
                        <h2>Histórico de Lançamentos</h2>
                        <div id="lancamentos-content">Conectando ao banco de dados...</div>
                        <h2>Adicionar Novo Lançamento</h2>
                        <form id="form-lancamento">
                            <input type="date" id="data" required>
                            <input type="text" id="ticker" placeholder="Ticker" required>
                            <input type="text" id="preco" placeholder="Preço (ex: R$ 10,50)" required>
                            <input type="number" id="quantidade" placeholder="Quantidade" step="any" required>
                            <select id="classe" required>
                                <option value="Ações">Ações</option>
                                <option value="FIIs">FIIs</option>
                                <option value="Criptomoedas">Criptomoedas</option>
                            </select>
                            <button type="submit">Adicionar Lançamento</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Importa as funções necessárias do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        document.addEventListener('DOMContentLoaded', function () {
            // --- CONFIGURAÇÃO DO FIREBASE ---
            const firebaseConfig = {
              apiKey: "AIzaSyA08o5_6YY7I1eCZ3DCPCopAJAUiC2JNdA",
              authDomain: "clarifica-invest.firebaseapp.com",
              projectId: "clarifica-invest",
              storageBucket: "clarifica-invest.appspot.com",
              messagingSenderId: "865871192847",
              appId: "1:865871192847:web:369d4b0edc96f74b29147a",
              measurementId: "G-6PG9XZJPB9"
            };

            // Inicializa o Firebase e seus serviços
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            const provider = new GoogleAuthProvider();

            // --- REFERÊNCIAS AOS ELEMENTOS DO DOM ---
            const btnLogin = document.getElementById('btn-login');
            const btnLogout = document.getElementById('btn-logout');
            const userInfoDiv = document.getElementById('user-info');
            const userPhoto = document.getElementById('user-photo');
            const userName = document.getElementById('user-name');
            const appContent = document.getElementById('app-content');
            const loginMessage = document.getElementById('login-message');
            
            // --- LÓGICA DE AUTENTICAÇÃO ---

            // Observador do estado de autenticação
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // Usuário está logado
                    console.log("Usuário logado:", user);
                    updateUIForLoggedInUser(user);
                    // IMPORTANTE: Inicia a lógica do banco de dados APENAS para usuários logados
                    setupFirestoreListeners(user.uid); 
                } else {
                    // Usuário está deslogado
                    console.log("Nenhum usuário logado.");
                    updateUIForLoggedOutUser();
                }
            });

            // Função de Login
            btnLogin.addEventListener('click', () => {
                signInWithPopup(auth, provider)
                    .catch((error) => {
                        console.error("Erro no login com Google: ", error);
                    });
            });

            // Função de Logout
            btnLogout.addEventListener('click', () => {
                signOut(auth).catch((error) => {
                    console.error("Erro ao fazer logout: ", error);
                });
            });


            // --- ATUALIZAÇÃO DA INTERFACE ---
            function updateUIForLoggedInUser(user) {
                loginMessage.style.display = 'none';
                appContent.style.display = 'block';
                userInfoDiv.style.display = 'flex';
                btnLogin.style.display = 'none';
                
                userName.textContent = user.displayName;
                userPhoto.src = user.photoURL;
            }

            function updateUIForLoggedOutUser() {
                loginMessage.style.display = 'block';
                appContent.style.display = 'none';
                userInfoDiv.style.display = 'none';
                btnLogin.style.display = 'block';

                document.getElementById('lancamentos-content').innerHTML = ''; // Limpa a lista de lançamentos
            }


            // --- LÓGICA DO FIRESTORE (BANCO DE DADOS) ---
            function setupFirestoreListeners(userId) {
                // A referência da coleção agora pode ser específica para o usuário se desejar
                // Ex: collection(db, 'users', userId, 'lancamentos');
                const lancamentosCollectionRef = collection(db, 'lancamentos');

                // 1. CARREGAR DADOS EM TEMPO REAL
                const q = query(lancamentosCollectionRef, orderBy("data", "desc"));
                onSnapshot(q, (snapshot) => {
                    const todosLancamentos = [];
                    snapshot.forEach(doc => {
                        todosLancamentos.push({ id: doc.id, ...doc.data() });
                    });
                    gerarHTMLlancamentos(todosLancamentos);
                }, error => {
                    console.error("Erro ao buscar lançamentos: ", error);
                    document.getElementById('lancamentos-content').innerHTML = "<p>Não foi possível conectar ao banco de dados.</p>";
                });
            }

            // 2. GERAR HTML
            function gerarHTMLlancamentos(lancamentos) {
                const container = document.getElementById('lancamentos-content');
                if (lancamentos.length === 0) {
                    container.innerHTML = '<p>Nenhum lançamento encontrado. Adicione o primeiro!</p>';
                    return;
                }
                const agrupados = lancamentos.reduce((acc, lancamento) => {
                    const classe = lancamento.classe;
                    if (!acc[classe]) acc[classe] = [];
                    acc[classe].push(lancamento);
                    return acc;
                }, {});
                
                let htmlFinal = '';
                for (const classe in agrupados) {
                    htmlFinal += `<div class="lancamentos-section"><h3>${classe}</h3><table class="lancamentos-table"><thead><tr><th>Data</th><th>Ticker</th><th>Preço</th><th>Quantidade</th><th>Ações</th></tr></thead><tbody>`;
                    agrupados[classe].forEach(lancamento => {
                        htmlFinal += `
                            <tr>
                                <td>${lancamento.data}</td>
                                <td>${lancamento.ticker}</td>
                                <td>${lancamento.preco}</td>
                                <td>${lancamento.quantidade}</td>
                                <td><button class="btn-delete" data-id="${lancamento.id}" data-ticker="${lancamento.ticker}">Excluir</button></td>
                            </tr>
                        `;
                    });
                    htmlFinal += `</tbody></table></div>`;
                }
                container.innerHTML = htmlFinal;
            }

            // 3. ADICIONAR LANÇAMENTO
            const form = document.getElementById('form-lancamento');
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                const novoLancamento = {
                    data: document.getElementById('data').value,
                    ticker: document.getElementById('ticker').value.toUpperCase(),
                    preco: document.getElementById('preco').value,
                    quantidade: document.getElementById('quantidade').value,
                    classe: document.getElementById('classe').value,
                    //userId: auth.currentUser.uid // Opcional: associar o lançamento ao usuário
                };
                
                try {
                    await addDoc(collection(db, 'lancamentos'), novoLancamento);
                    form.reset();
                } catch (error) {
                    console.error("Erro ao adicionar documento: ", error);
                }
            });

            // 4. EXCLUIR LANÇAMENTO (usando event delegation)
            const contentDiv = document.getElementById('lancamentos-content');
            contentDiv.addEventListener('click', async (event) => {
                if (event.target.classList.contains('btn-delete')) {
                    const id = event.target.dataset.id;
                    const ticker = event.target.dataset.ticker;
                    if (confirm(`Tem certeza que deseja excluir o lançamento de ${ticker}?`)) {
                        try {
                            await deleteDoc(doc(db, 'lancamentos', id));
                        } catch (error) {
                            console.error("Erro ao remover documento: ", error);
                        }
                    }
                }
            });
            
            // Lógica das Abas (sem alteração)
            const tabs = document.querySelectorAll('.nav-tabs .nav-link');
            const tabPanes = document.querySelectorAll('.tab-pane');
            tabs.forEach(tab => {
                tab.addEventListener('click', function (event) {
                    event.preventDefault();
                    tabs.forEach(t => t.classList.remove('active'));
                    tabPanes.forEach(p => p.classList.remove('active'));
                    this.classList.add('active');
                    const activeTabContentId = this.getAttribute('data-tab');
                    document.getElementById(activeTabContentId).classList.add('active');
                });
            });
        });
    </script>
</body>
</html>
